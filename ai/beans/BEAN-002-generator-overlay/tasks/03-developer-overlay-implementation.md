# Task 03: Implement Overlay Engine + CLI Flags

| Field | Value |
|-------|-------|
| **Owner** | developer |
| **Depends On** | 02 |
| **Status** | Done |

## Goal

Implement the overlay mode in the generator pipeline and add `--overlay` and `--dry-run` flags to the CLI. Write tests alongside the implementation.

## Inputs

- `ai/outputs/architect/bean-002-overlay-design.md` — design spec
- `ai/outputs/ba/bean-002-overlay-requirements.md` — requirements and edge cases
- `ai/beans/BEAN-002-generator-overlay/bean.md` — acceptance criteria
- `foundry_app/services/generator.py` — pipeline to modify
- `foundry_app/services/scaffold.py` — scaffold to make overlay-aware
- `foundry_app/cli.py` — CLI to add flags
- `foundry_app/core/models.py` — models to extend if needed
- Existing tests in `tests/` for patterns

## Deliverables

### Code changes (in the codebase):

1. **Overlay engine** — implement per the Architect's design:
   - Conflict detection (compare generated content against existing files)
   - Write-or-skip logic (new files are written, unchanged files skipped, conflicts reported)
   - Manifest-aware diffing if previous manifest exists

2. **Dry-run mode** — generate without writing:
   - Collect what would be created, updated, skipped, conflicted
   - Print a summary report to stdout

3. **CLI changes in `foundry_app/cli.py`:**
   - `--overlay` flag on `generate` subcommand
   - `--dry-run` flag on `generate` subcommand
   - Updated `_cmd_generate()` to pass flags through to `generate_project()`

4. **Model changes** (if needed per design):
   - Extend `StageResult` or add an `OverlayResult` type
   - Track skipped/conflicted files in the manifest

5. **Tests in `tests/`:**
   - Overlay into empty dir (behaves like normal generate)
   - Overlay into dir with existing non-Foundry files (left untouched)
   - Overlay into dir with unchanged Foundry files (skipped)
   - Overlay into dir with modified Foundry files (conflict reported)
   - Dry-run produces report without writing
   - CLI arg parsing for `--overlay` and `--dry-run`

### Implementation notes:
Write to `ai/outputs/developer/bean-002-overlay-notes.md`:
- What changed and where
- Any deviations from the design spec (with rationale)
- Known limitations or follow-up items

## Acceptance Criteria

- [ ] `foundry-cli generate --overlay <dir>` writes into an existing directory
- [ ] Existing files not generated by Foundry are left untouched
- [ ] Conflicts are reported clearly (file path + reason)
- [ ] `--dry-run` flag shows planned changes without writing
- [ ] Tests cover overlay, conflict detection, and dry-run scenarios
- [ ] `uv run pytest` — all tests pass (existing + new)
- [ ] `uv run ruff check foundry_app/` — lint clean

## Definition of Done

- [ ] All code changes committed and tests passing
- [ ] `ai/outputs/developer/bean-002-overlay-notes.md` exists
- [ ] No regressions in existing 248 tests
- [ ] Ready for Tech-QA verification
