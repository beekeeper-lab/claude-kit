# Task 04: Test Overlay, Conflicts, and Dry-Run

| Field | Value |
|-------|-------|
| **Owner** | tech-qa |
| **Depends On** | 03 |
| **Status** | Done |

## Goal

Verify the overlay implementation against all acceptance criteria. Write additional tests for edge cases the Developer may have missed. Produce a quality report with pass/fail assessment.

## Inputs

- `ai/outputs/developer/bean-002-overlay-notes.md` — what changed and where
- `ai/outputs/ba/bean-002-overlay-requirements.md` — requirements and edge cases
- `ai/outputs/architect/bean-002-overlay-design.md` — design spec
- `ai/beans/BEAN-002-generator-overlay/bean.md` — acceptance criteria
- Code changes in `foundry_app/` and `tests/`

## Deliverables

### Test execution:

1. **Run full test suite:** `uv run pytest` — verify no regressions
2. **Run lint:** `uv run ruff check foundry_app/` — verify clean

### Verification against acceptance criteria:

For each criterion in the bean, verify and document pass/fail:
- [ ] `foundry-cli generate --overlay <dir>` writes into an existing directory
- [ ] Existing files not generated by Foundry are left untouched
- [ ] Conflicts are reported clearly (file path + reason)
- [ ] `--dry-run` flag shows planned changes without writing
- [ ] Tests cover overlay, conflict detection, and dry-run scenarios

### Additional edge case testing:

Write tests in `tests/` for any gaps found:
- Overlay when target dir does not exist
- Overlay when `settings.local.json` has been hand-edited
- Overlay after adding a new persona to the composition
- Overlay after removing a persona (orphaned agent files)
- Dry-run on a dir with conflicts (verify nothing is written)
- Double overlay (run overlay twice — second run should be all skips)

### Quality report:

Write to `ai/outputs/tech-qa/bean-002-overlay-qa-report.md`:
- Test results summary (total, pass, fail, new tests added)
- Acceptance criteria checklist with pass/fail
- Edge cases tested with results
- Any bugs found (with reproduction steps)
- Go/no-go recommendation

## Acceptance Criteria

- [ ] All existing tests pass (no regressions)
- [ ] All bean acceptance criteria verified with evidence
- [ ] Edge case tests added for at least 4 additional scenarios
- [ ] Bug reports filed for any defects found
- [ ] Lint clean
- [ ] Quality report written with go/no-go recommendation

## Definition of Done

- [ ] `ai/outputs/tech-qa/bean-002-overlay-qa-report.md` exists
- [ ] All tests pass (`uv run pytest`)
- [ ] Lint clean (`uv run ruff check foundry_app/`)
- [ ] Go/no-go recommendation delivered to Team Lead
