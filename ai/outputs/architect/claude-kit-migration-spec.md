# Spec: Migrate Existing Projects to claude-kit Subtree

## Overview

This spec is for projects that were previously generated by Foundry and have a local `.claude/` directory. It replaces that directory with a git subtree linked to the shared `claude-kit` repository, giving the project access to the latest skills, commands, agents, and hooks.

## Prerequisites

- The `claude-kit` repo exists and is accessible (e.g., `github.com/beekeeper-lab/claude-kit`)
- The project is a git repository with a clean working tree
- The project currently has a `.claude/` directory (committed or untracked)

## Migration Steps

### Step 1: Back up project-specific customizations

Before replacing `.claude/`, check if the project has any local customizations that differ from the shared templates.

```bash
# Review what's in .claude/ currently
ls -la .claude/
```

If the project has project-specific settings, hooks, or overrides that should NOT come from claude-kit, note them. These will be re-applied after the migration, or moved to a project-specific override location.

### Step 2: Remove the existing `.claude/` directory from git

```bash
# Remove .claude/ from git tracking (keeps files on disk temporarily)
git rm -r --cached .claude/

# Now delete the actual directory
rm -rf .claude/

# Commit the removal
git commit -m "Remove local .claude/ in preparation for claude-kit subtree"
```

### Step 3: Add the claude-kit subtree

```bash
# Add the remote (one-time setup)
git remote add claude-kit git@github.com:beekeeper-lab/claude-kit.git

# Pull the subtree into .claude/
git subtree add --prefix=.claude claude-kit main --squash
```

This creates a single squashed commit containing the entire claude-kit history, placed at `.claude/`. The `--squash` flag keeps the project's git log clean.

### Step 4: Verify Claude Code reads the files

```bash
# Check that skills, commands, and agents are visible
ls .claude/skills/
ls .claude/commands/
ls .claude/agents/

# Start Claude Code and verify slash commands work
claude
# Then try: /help or any slash command to confirm
```

### Step 5: Re-apply project-specific customizations

If the project had customizations noted in Step 1:

**Option A: Edit directly in `.claude/`** — Simple, but changes will need to be pushed back to claude-kit or they'll be overwritten on the next pull.

**Option B: Use a `.claude.local/` override directory** — If claude-kit supports this pattern, place project-specific files there. These won't be overwritten by subtree pulls. *(This requires claude-kit to be designed with override support.)*

**Option C: Commit project-specific changes and push to claude-kit** — If the customization is useful for all projects, push it upstream:
```bash
git subtree push --prefix=.claude claude-kit main
```

### Step 6: Set up convenience aliases

Add these to the project's shell config or document them in the project README:

```bash
# Pull latest shared config from claude-kit
alias claude-pull='git subtree pull --prefix=.claude claude-kit main --squash'

# Push local changes back to claude-kit
alias claude-push='git subtree push --prefix=.claude claude-kit main'
```

### Step 7: Commit and push

```bash
git push origin main
```

## Ongoing Usage

### Pulling updates from claude-kit

When skills, commands, or agents are updated in the shared repo:

```bash
claude-pull
# or: git subtree pull --prefix=.claude claude-kit main --squash
```

This creates a merge commit in the project with all claude-kit changes squashed into one.

### Pushing changes back to claude-kit

When you improve a skill while working in this project and want to share it:

```bash
claude-push
# or: git subtree push --prefix=.claude claude-kit main
```

Then other projects pull the update with `claude-pull`.

### What NOT to do

- **Don't `git clone` claude-kit separately inside `.claude/`** — the subtree handles this.
- **Don't manually copy files from claude-kit** — use `claude-pull`.
- **Don't delete `.claude/` and re-add** — use `claude-pull` to update in place.

## Troubleshooting

### "Working tree has modifications" error on subtree pull

```bash
git stash
claude-pull
git stash pop
```

### Merge conflicts on subtree pull

The project may have edited files in `.claude/` that were also changed upstream. Resolve conflicts normally:

```bash
claude-pull
# If conflicts: resolve them in the affected files
git add .claude/
git commit
```

### "fatal: refusing to merge unrelated histories" on first subtree add

This happens if `.claude/` was removed and you're re-adding. Use:

```bash
git subtree add --prefix=.claude claude-kit main --squash
```

The `--squash` flag avoids the unrelated histories issue.

### Remote not found

```bash
# Verify the remote is configured
git remote -v

# If claude-kit is missing, add it
git remote add claude-kit git@github.com:beekeeper-lab/claude-kit.git
```

## Verification Checklist

After migration, confirm:

- [ ] `.claude/` directory exists with skills, commands, agents, hooks
- [ ] `git remote -v` shows the `claude-kit` remote
- [ ] `claude-pull` works (no errors)
- [ ] Claude Code recognizes slash commands (start claude, try `/help`)
- [ ] Project-specific customizations are preserved
- [ ] `git log --oneline -5` shows the subtree add commit

## Example: Full Migration Script

For a quick migration of a project at `~/workspace/my-project`:

```bash
cd ~/workspace/my-project

# Ensure clean state
git status  # should be clean

# Remove old .claude/
git rm -r --cached .claude/ 2>/dev/null
rm -rf .claude/
git commit -m "Remove local .claude/ for claude-kit migration" --allow-empty

# Add subtree
git remote add claude-kit git@github.com:beekeeper-lab/claude-kit.git
git subtree add --prefix=.claude claude-kit main --squash

# Verify
ls .claude/skills/
echo "Migration complete. Run 'claude' to verify."
```
