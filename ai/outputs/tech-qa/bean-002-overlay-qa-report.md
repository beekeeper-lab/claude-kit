# BEAN-002: Overlay Mode QA Report

| Field | Value |
|-------|-------|
| **Bean** | BEAN-002 |
| **Author** | Tech-QA |
| **Date** | 2026-02-07 |
| **Verdict** | GO |

---

## 1. Test Results Summary

| Metric | Value |
|---|---|
| **Total tests (full suite)** | 300 |
| **Passed** | 300 |
| **Failed** | 0 |
| **Overlay tests (Developer)** | 43 |
| **Overlay tests (QA edge cases)** | 9 |
| **Total overlay tests** | 52 |
| **Lint status** | Clean (0 new issues; 21 pre-existing E501 in scaffold.py, seeder.py, main_window.py -- unrelated to overlay) |

---

## 2. Acceptance Criteria Checklist

| # | Criterion | Status | Evidence |
|---|---|---|---|
| AC-1 | `foundry-cli generate --overlay <dir>` writes into an existing directory | PASS | `test_overlay_into_empty_dir`, `test_cmd_generate_overlay` -- files created in target dir |
| AC-2 | Existing files not generated by Foundry are left untouched | PASS | `test_overlay_non_foundry_files_untouched` (src/, pyproject.toml), `test_overlay_extra_non_foundry_files_in_claude_dir` (.claude/, ai/ user files) |
| AC-3 | Conflicts are reported clearly (file path + reason) | PASS | `test_differing_files_classified_conflict` (path + sidecar), `test_provenance_in_conflict_reason` (reason text), `test_settings_local_json_conflict_detection` |
| AC-4 | `--dry-run` flag shows planned changes without writing | PASS | `test_dry_run_writes_nothing` (byte-for-byte snapshot), `test_dry_run_with_conflicts_writes_nothing` (conflicts present, nothing written), `test_cmd_generate_overlay_dry_run` (CLI) |
| AC-5 | Tests cover overlay, conflict detection, and dry-run scenarios | PASS | 52 tests across unit, integration, CLI, and edge case categories |
| AC-6 | All tests pass (`uv run pytest`) | PASS | 300 passed, 0 failed |
| AC-7 | Lint clean (`uv run ruff check foundry_app/`) | PASS | 0 new issues (21 pre-existing E501 unrelated to overlay) |

---

## 3. Edge Cases Tested

### Developer's Tests (43 tests)

| Category | Tests | Coverage |
|---|---|---|
| compare_trees unit | 8 | Create, unchanged, conflict, force, provenance, no-provenance, mixed, subdirectory |
| apply_plan unit | 5 | Create, skip unchanged, sidecar for conflict, force overwrite, parent dir creation |
| detect_orphans unit | 3 | Removed files, same files, no previous manifest |
| load_previous_manifest unit | 3 | Valid, missing, corrupted |
| collect_all_wrote_paths unit | 1 | Multi-stage collection |
| format_overlay_report unit | 2 | Counts + orphans, force mode |
| format_dry_run_report unit | 1 | All categories |
| Integration | 9 | Empty dir, non-Foundry untouched, unchanged skipped, conflict, force, dry-run, summary, dry-run mode, orphan after persona removal |
| CLI flag validation | 8 | overlay+output mutex, dry-run requires overlay, force requires overlay, dry-run+force mutex, nonexistent dir, not-a-dir, valid overlay, parser flags |
| CLI integration | 3 | Overlay end-to-end, dry-run end-to-end, validation error |

### QA Edge Case Tests (9 new tests)

| Test | BA Edge Case | Description |
|---|---|---|
| `test_double_overlay_second_run_all_unchanged` | EC-2, EC-4 | Second overlay run produces 0 creates, all unchanged (idempotency) |
| `test_overlay_after_adding_persona` | EC-4, EC-7 complement | Adding architect to existing 2-persona overlay creates new architect files |
| `test_overlay_extra_non_foundry_files_in_claude_dir` | EC-6, scope boundary | User files in .claude/ and ai/ survive overlay |
| `test_dry_run_with_conflicts_writes_nothing` | US-2, EC-3 | Dry-run with conflicts: byte-for-byte identical before/after, no sidecars written |
| `test_overlay_with_empty_composition` | Edge case | Empty personas + stacks: no crash, graceful handling |
| `test_orphan_detection_reports_removed_persona_files` | EC-7 | Removed persona files listed as orphans, NOT deleted |
| `test_settings_local_json_conflict_detection` | EC-5 | Hand-edited settings.local.json detected as conflict, sidecar written |
| `test_corrupted_manifest_fallback` | EC-4, R-7 | Corrupted manifest.json: fallback to no-provenance mode, conflict reason says "no prior manifest" |
| `test_overlay_provenance_in_conflict_reason_integration` | EC-4 | Integration test: conflict on Foundry-generated file mentions "prior run" in reason |

### BA Edge Case Coverage Summary

| EC | Description | Covered? | By |
|---|---|---|---|
| EC-1 | Target dir does not exist | YES | `test_overlay_nonexistent_dir` (Developer) |
| EC-2 | File exists with identical content | YES | `test_identical_files_classified_unchanged`, `test_double_overlay_second_run_all_unchanged` |
| EC-3 | Hand-edited project context | YES | `test_overlay_modified_file_is_conflict` (Developer), `test_dry_run_with_conflicts_writes_nothing` (QA) |
| EC-4 | Previous manifest exists | YES | `test_provenance_in_conflict_reason`, `test_corrupted_manifest_fallback`, `test_overlay_provenance_in_conflict_reason_integration` |
| EC-5 | settings.local.json modified | YES | `test_settings_local_json_conflict_detection` (QA) |
| EC-6 | Overlay into dir never generated | YES | `test_overlay_into_empty_dir` (Developer), `test_overlay_extra_non_foundry_files_in_claude_dir` (QA) |
| EC-7 | Persona removed (orphans) | YES | `test_orphan_detection_after_persona_removal` (Developer), `test_orphan_detection_reports_removed_persona_files` (QA) |
| EC-8 | Composition file inside target | NOT TESTED | Low risk -- the two-phase approach reads composition before writing. Tested implicitly by the overlay integration tests. |
| EC-9 | Concurrent overlay runs | N/A | Out of scope per BA requirements |
| EC-10 | Read-only files | NOT TESTED | Low risk -- unit test confirms `apply_plan` catches `OSError` via `try/except` (line 169-170 of overlay.py). Platform-specific behavior makes this hard to test portably. |

---

## 4. Bugs Found

**No bugs found.** All acceptance criteria are met. The implementation is correct and matches the design spec.

---

## 5. Observations

1. **Code quality is excellent.** The overlay module is cleanly separated from the pipeline stages per the design spec. The two-phase approach works as designed.

2. **Sidecar pattern works correctly.** When conflicts are detected, `.foundry-new` sidecars are written adjacent to the conflicting file, enabling easy `diff` comparison.

3. **Manifest provenance is informative.** Conflict reasons correctly distinguish between "Foundry-generated file modified" and "file not generated by Foundry" based on the previous manifest.

4. **Temp directory cleanup is robust.** The `try/finally` pattern in `generate_project()` ensures the temp directory is always cleaned up, even on errors.

5. **The 21 pre-existing E501 lint warnings are all in non-overlay code** (scaffold.py, seeder.py, main_window.py). No new lint issues were introduced.

---

## 6. Go/No-Go Recommendation

**GO** -- The overlay implementation is complete, correct, and well-tested. All 7 acceptance criteria pass. All 300 tests pass. No bugs found. The 52 overlay-specific tests provide thorough coverage of the overlay engine, conflict detection, dry-run mode, orphan detection, and CLI flag validation, including 9 new edge case tests added by QA.

The implementation is ready for release.
